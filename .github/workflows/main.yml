name: Deploy Airflow

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. SSH를 통해 서버에 파일 복사 (rsync 활용)
      # git pull보다 rsync가 더 빠르고 권한 관리가 쉽습니다.
      - name: Copy files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "."
          target: "/home/${{ secrets.SSH_USER }}/PycharmProjects/ChzzkAggregate"
          rm: false # 기존 파일 유지하며 덮어쓰기

      # 3. 원격 서버에서 환경 변수 설정 및 스크립트 실행
      - name: Execute Remote Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /home/${{ secrets.SSH_USER }}/PycharmProjects/ChzzkAggregate
            
            # .env 파일 생성 (보안을 위해 서버에서 직접 생성)
            echo "AIRFLOW_CONN_CHZZK_API_CONN=${{ secrets.AIRFLOW_CONN_CHZZK_API_CONN }}" > .env
            echo "AIRFLOW_CONN_MONGODB_CONN=${{ secrets.AIRFLOW_CONN_MONGODB_CONN }}" >> .env
            echo "AIRFLOW_CONN_S3_CONN=${{ secrets.AIRFLOW_CONN_S3_CONN }}" >> .env
            
            # 실행 권한 부여 및 배포 스크립트 실행
            chmod +x setup_airflow.bash
            ./setup_airflow.bash
